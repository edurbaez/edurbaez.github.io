<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ConversaciÃ³n con GPT-4o</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: sans-serif;
      padding: 1rem;
      margin: 0;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #container {
      width: 100%;
      max-width: 700px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #chat {
      background: #fff;
      padding: 1rem;
      border: 1px solid #ccc;
      max-height: 50vh;
      overflow-y: auto;
      white-space: pre-wrap;
      border-radius: 0.5rem;
    }

    textarea {
      width: 100%;
      height: 100px;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      resize: vertical;
    }

    button, select {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.5rem;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    select {
      background-color: #ffffff;
      color: #333;
      border: 1px solid #ccc;
    }

    @media (min-width: 600px) {
      button, select {
        width: auto;
      }

      #button-group {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <div id="container">
  <!-- aquÃ­ va el chat, textarea, botones, etc. -->

  <h2>ConversaciÃ³n con GPT-4o</h2>
  <div id="chat"></div>
  <textarea id="userInput" placeholder="Escribe tu mensaje aquÃ­..."></textarea>
  <br>
  <button onclick="enviarMensaje()">Enviar</button>
  <button id="botonDictar">ğŸ¤ Mensaje de voz (mantÃ©n presionado)</button>
  <label for="idioma">Idioma de dictado:</label>
    <select id="idioma">
    <option value="de-DE">AlemÃ¡n ğŸ‡©ğŸ‡ª</option>
    <option value="es-ES">EspaÃ±ol ğŸ‡ªğŸ‡¸</option>
    <option value="en-US">InglÃ©s ğŸ‡ºğŸ‡¸</option>
    <option value="fr-FR">FrancÃ©s ğŸ‡«ğŸ‡·</option>
    <option value="it-IT">Italiano ğŸ‡®ğŸ‡¹</option>
    </select>
  <br>
  <button id="btnPermisoMicrofono" onclick="solicitarPermisoMicrofono()" style="display: none;">
  ğŸ™ï¸ Activar micrÃ³fono
</button>
  </div>


  <script>
    // Historial de la conversaciÃ³n
    const conversation = [
      { role: "system", content: "Eres un asistente conversacional para alguen que esta aprendiendo idiomas (responde en el idioma que te hablen) en ese sentido siempre vas a mantener un nivel de comunicacion basico para que alguen que esta en nivel A1 pueda entenderte y tus respuestas deben ser los mas cortas posible, por debajo de 20 palabras a menos que sea necesario para dar una mejor respuesta, vas a tener como finalidad mantener la conversacion, manteniendo el tema de conversacion del usuario o proponiende temas y haciendo preguntas para que la conversacion siga fluyendo,Ãºtil. solo usas los signos de puntucion que no se pronuncien como , o , o :" }
    ];

    // Referencia al elemento donde se mostrarÃ¡ la conversaciÃ³n
    const chatDiv = document.getElementById("chat");

    // FunciÃ³n para actualizar el chat en la pÃ¡gina
    function actualizarChat() {
      chatDiv.innerHTML = "";
      conversation.forEach(msg => {
        if (msg.role === "system") return; // â›” No mostrar mensajes del sistema
        // Crear un nuevo elemento de pÃ¡rrafo para cada mensaje
        const p = document.createElement("p");
        p.textContent = (msg.role === "user" ? "Usuario: " : (msg.role === "assistant" ? "Asistente: " : "")) + msg.content;
        chatDiv.appendChild(p);
      });
      // Desplazar hacia abajo para ver el mensaje mÃ¡s reciente
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

async function enviarMensaje() {
  const inputElem = document.getElementById("userInput");
  const mensajeUsuario = inputElem.value.trim();
  if (!mensajeUsuario) return;

  // Agregar el mensaje del usuario al historial
  conversation.push({ role: "user", content: mensajeUsuario });
  actualizarChat();
  inputElem.value = "";

  try {
    // Llamar a tu backend en Glitch
    const response = await fetch("https://eddward.glitch.me/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ mensaje: mensajeUsuario })
    });

    const data = await response.json();
    const respuestaGPT = data.respuesta;

    if (respuestaGPT) {
      conversation.push({ role: "assistant", content: respuestaGPT });
    } else {
      conversation.push({ role: "assistant", content: "No se recibiÃ³ respuesta vÃ¡lida del servidor." });
    }
  } catch (error) {
    console.error("Error al contactar con el backend:", error);
    conversation.push({ role: "assistant", content: "Error de conexiÃ³n con el servidor." });
  }

  actualizarChat();
  leerUltimaRespuesta(); // Leer respuesta con voz
}


    // Dictado por voz (Web Speech API)
    let recognition;

    function iniciarDictado() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Tu navegador no soporta reconocimiento de voz.");
            return;
        }
        // ğŸ”‡ Detener cualquier lectura en curso
        speechSynthesis.cancel();

        const inputElem = document.getElementById("userInput"); // â¬…ï¸ Aseguramos que estÃ© definido
        const idioma = document.getElementById("idioma").value; // â¬…ï¸ idioma elegido
        recognition = new webkitSpeechRecognition();
        recognition.lang = idioma; // AlemÃ¡n
        recognition.interimResults = true;
        recognition.continuous = true;

        recognition.onresult = function(event) {
            let textoFinal = '';
            let textoParcial = '';

            for (let i = event.resultIndex; i < event.results.length; ++i) {
            const resultado = event.results[i];
            if (resultado.isFinal) {
                textoFinal += resultado[0].transcript + ' ';
            } else {
                textoParcial += resultado[0].transcript;
            }
            }

            inputElem.value = textoFinal + textoParcial;
        };

        recognition.onerror = function(event) {
            console.error("Error de reconocimiento:", event.error);
        };

        recognition.start();
        }

    // Detener el dictado


    function detenerDictado() {
      if (recognition) recognition.stop();
      enviarMensaje();

    }

    // leer respuesta del modelo
    function leerUltimaRespuesta() {
        const ultima = conversation.slice().reverse().find(msg => msg.role === "assistant");
        if (!ultima) return;

        const texto = ultima.content;
        const utterance = new SpeechSynthesisUtterance(texto);
        const idioma = document.getElementById("idioma").value; // â¬…ï¸ idioma elegido
        utterance.lang = idioma; // AlemÃ¡n
        utterance.rate = 1;
        speechSynthesis.speak(utterance);
        }

    // Asignar eventos al botÃ³n de dictado
    document.addEventListener("DOMContentLoaded", () => {
      const botonDictar = document.getElementById("botonDictar");

      const empezarDictado = (e) => {
        e.preventDefault(); // âš ï¸ Previene conflictos
        iniciarDictado();
      };

      const pararDictado = (e) => {
        e.preventDefault();
        detenerDictado();
      };

      // Eventos tÃ¡ctiles (mÃ³viles/tablets)
      botonDictar.addEventListener("touchstart", empezarDictado, { passive: false });
      botonDictar.addEventListener("touchend", pararDictado);

      // Eventos de ratÃ³n (PC)
      botonDictar.addEventListener("mousedown", empezarDictado);
      botonDictar.addEventListener("mouseup", pararDictado);
    });
    // Asignar eventos al test
    if (!('webkitSpeechRecognition' in window)) {
      alert("Este navegador no soporta reconocimiento de voz (usa Chrome en Android).");
    }

    // Solicitar permiso para el micrÃ³fono
    document.addEventListener("DOMContentLoaded", () => {
  const boton = document.getElementById("btnPermisoMicrofono");

  // Intentamos acceder al micrÃ³fono
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then((stream) => {
      // ğŸ‰ Permiso concedido: ocultar botÃ³n (si estaba visible)
      boton.style.display = "none";
      // Importante: detener el uso del micrÃ³fono
      stream.getTracks().forEach(track => track.stop());
    })
    .catch((err) => {
      // âŒ Permiso denegado o aÃºn no concedido
      console.warn("No hay permiso para el micrÃ³fono:", err.name);
      boton.style.display = "inline-block";
    });
});

function solicitarPermisoMicrofono() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("Tu navegador no soporta acceso al micrÃ³fono.");
    return;
  }

  alert("Se solicitarÃ¡ acceso al micrÃ³fono una sola vez. Luego podrÃ¡s usar el dictado por voz.");

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then((stream) => {
      console.log("Permiso concedido");
      // Se recomienda detener el stream inmediatamente
      stream.getTracks().forEach(track => track.stop());
      document.getElementById("btnPermisoMicrofono").style.display = "none";
    })
    .catch((err) => {
      console.error("Permiso denegado o error:", err);
      alert("Necesitas dar permiso al micrÃ³fono para usar dictado por voz.");
    });
}

    

    // Inicializar el chat con el mensaje del sistema (opcional)
    actualizarChat();



  </script>
</body>
</html>
